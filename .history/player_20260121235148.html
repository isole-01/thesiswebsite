<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audio player</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; }
    .meta { margin-top: 16px; }
    dt { font-weight: 600; }
    dd { margin: 0 0 12px 0; }
    code { background: #f4f4f4; padding: 2px 6px; border-radius: 4px; }
    section { margin: 16px 0; }
    audio { width: 100%; }
  </style>
</head>
<body>
  <div id="clips"></div>

  <script>
    function getParam(name) {
      return new URLSearchParams(window.location.search).get(name);
    }

    function fmt(v) {
      if (v === null || v === undefined || v === "" || v === "None") return "—";
      if (Array.isArray(v)) return v.map(x => (x == null ? "—" : String(x))).join(", ");
      return String(v);
    }

    const id = getParam("id");
    const clipsEl = document.getElementById("clips");

    if (!id) {
      clipsEl.textContent = "Add a link like player.html?id=bluestextonly";
      throw new Error("Missing id");
    }

    async function pickAudioSrc(baseNoExt) {
      const mp3 = baseNoExt + ".mp3";
      const wav = baseNoExt + ".wav";
      const r1 = await fetch(mp3, { method: "HEAD" }).catch(() => null);
      if (r1 && r1.ok) return mp3;
      const r2 = await fetch(wav, { method: "HEAD" }).catch(() => null);
      if (r2 && r2.ok) return wav;
      return null;
    }

    async function renderOne(folder, stem) {
      const section = document.createElement("section");

      const dl = document.createElement("dl");
      dl.innerHTML = `
        <dt>Prompt</dt><dd class="prompt">—</dd>
        <dt>Reward Functions</dt><dd class="rewards">—</dd>
      `;
      section.appendChild(dl);

      const audio = document.createElement("audio");
      audio.controls = true;
      audio.preload = "metadata";
      section.appendChild(audio);

      clipsEl.appendChild(section);

      const src = await pickAudioSrc(`${folder}${stem}`);
      if (src) audio.src = src;
      else section.querySelector(".prompt").textContent = "Audio file not found.";

      const metaUrl = `${folder}${stem}.json`;
      const res = await fetch(metaUrl).catch(() => null);
      if (res && res.ok) {
        const meta = await res.json();
        section.querySelector(".prompt").textContent  = fmt(meta.prompt);
        section.querySelector(".rewards").textContent = fmt(meta.finetuned_rewards);
      } else {
        section.querySelector(".prompt").textContent = "Error loading metadata.";
      }
    }

    (async () => {
      // New behavior: id is a folder containing a manifest.json
      const folder = `audio/${id}/`;
      const m = await fetch(folder + "manifest.json").catch(() => null);

      if (m && m.ok) {
        const stems = await m.json(); // e.g. ["a1","a2"]
        for (const stem of stems) await renderOne(folder, stem);
        return;
      }

      // Fallback: old behavior (id refers to single file in audio/)
      await renderOne("audio/", id);
    })().catch(err => {
      clipsEl.textContent = "Error.";
      console.error(err);
    });
  </script>
</body>
</html>
